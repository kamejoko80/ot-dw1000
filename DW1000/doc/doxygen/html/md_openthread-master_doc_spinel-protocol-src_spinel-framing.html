<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OT-DW1000: Framing Protocol</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Open-Thread-Logo-200x42.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OT-DW1000
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Framing Protocol </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Since this NCP protocol is defined independently of the physical transport or framing, any number of transports and framing protocols could be used successfully. However, in the interests of compatibility, this document provides some recommendations.</p>
<h2>UART Recommendations</h2>
<p>The recommended default UART settings are:</p>
<ul>
<li>Bit rate: 115200</li>
<li>Start bits: 1</li>
<li>Data bits: 8</li>
<li>Stop bits: 1</li>
<li>Parity: None</li>
<li>Flow Control: Hardware</li>
</ul>
<p>These values may be adjusted depending on the individual needs of the application or product, but some sort of flow control <b>MUST</b> be used. Hardware flow control is preferred over software flow control. In the absence of hardware flow control, software flow control (XON/XOFF) <b>MUST</b> be used instead.</p>
<p>We also <b>RECOMMEND</b> an Arduino-style hardware reset, where the DTR signal is coupled to the <code>R̅E̅S̅</code> pin through a 0.01µF capacitor. This causes the NCP to automatically reset whenever the serial port is opened. At the very least we <b>RECOMMEND</b> dedicating one of your host pins to controlling the <code>R̅E̅S̅</code> pin on the NCP, so that you can easily perform a hardware reset if necessary.</p>
<h3>UART Bit Rate Detection</h3>
<p>When using a UART, the issue of an appropriate bit rate must be considered. A bitrate of 115200 bits per second has become a defacto standard baud rate for many serial peripherals. This rate, however, is slower than the theoretical maximum bitrate of the 802.15.4 2.4GHz PHY (250kbit). In most circumstances this mismatch is not significant because the overall bitrate will be much lower than either of these rates, but there are circumstances where a faster UART bitrate is desirable. Thus, this document proposes a simple bitrate detection scheme that can be employed by the host to detect when the attached NCP is initially running at a higher bitrate.</p>
<p>The algorithm is to send successive NOOP commands to the NCP at increasing bitrates. When a valid <code>CMD_LAST_STATUS</code> response has been received, we have identified the correct bitrate.</p>
<p>In order to limit the time spent hunting for the appropriate bitrate, we RECOMMEND that only the following bitrates be checked:</p>
<ul>
<li>115200</li>
<li>230400</li>
<li>1000000 (1Mbit)</li>
</ul>
<p>The bitrate MAY also be changed programmatically by adjusting <code>PROP_UART_BITRATE</code>, if implemented.</p>
<p><em>HDLC-Lite</em> is the recommended framing protocol for transmitting Spinel frames over a UART. HDLC-Lite consists of only the framing, escaping, and CRC parts of the larger HDLC protocol&mdash;all other parts of HDLC are omitted. This protocol was chosen because it works well with software flow control and is widely implemented.</p>
<p>To transmit a frame with HDLC-lite, the 16-bit CRC must first be appended to the frame. The CRC function is defined to be CRC-16/CCITT, otherwise known as the <a href="http://reveng.sourceforge.net/crc-catalogue/16.htm#crc.cat.kermit">KERMIT CRC</a>.</p>
<p>Individual frames are terminated with a frame delimiter octet called the 'flag' octet (<code>0x7E</code>).</p>
<p>The following octets values are considered <em>special</em> and should be escaped when present in data frames:</p>
<table class="doxtable">
<tr>
<th>Octet Value </th><th>Description  </th></tr>
<tr>
<td>0x7E </td><td>Frame Delimiter (Flag) </td></tr>
<tr>
<td>0x7D </td><td>Escape Byte </td></tr>
<tr>
<td>0x11 </td><td>XON </td></tr>
<tr>
<td>0x13 </td><td>XOFF </td></tr>
<tr>
<td>0xF8 </td><td>Vendor-Specific </td></tr>
</table>
<p>When present in a data frame, these octet values are escaped by prepending the escape octet (<code>0x7D</code>) and XORing the value with <code>0x20</code>.</p>
<p>When receiving a frame, the CRC must be verified after the frame is unescaped. If the CRC value does not match what is calculated for the frame data, the frame MUST be discarded. The implementation MAY indicate the failure to higher levels to handle as they see fit, but MUST NOT attempt to process the deceived frame.</p>
<p>Consecutive flag octets are entirely legal and MUST NOT be treated as a framing error. Consecutive flag octets MAY be used as a way to wake up a sleeping NCP.</p>
<p>When first establishing a connection to the NCP, it is customary to send one or more flag octets to ensure that any previously received data is discarded.</p>
<h2>SPI Recommendations</h2>
<p>We RECOMMEND the use of the following standard SPI signals:</p>
<ul>
<li><code>C̅S̅</code>: (Host-to-NCP) Chip Select</li>
<li><code>CLK</code>: (Host-to-NCP) Clock</li>
<li><code>MOSI</code>: Master-Output/Slave-Input</li>
<li><code>MISO</code>: Master-Input/Slave-Output</li>
<li><code>I̅N̅T̅</code>: (NCP-to-Host) Host Interrupt</li>
<li><code>R̅E̅S̅</code>: (Host-to-NCP) NCP Hardware Reset</li>
</ul>
<p>The <code>I̅N̅T̅</code> signal is used by the NCP to indicate to the host that the NCP has frames pending to send to it. When asserted, the host SHOULD initiate a SPI transaction in a timely manner.</p>
<p>We RECOMMEND the following SPI properties:</p>
<ul>
<li><code>C̅S̅</code> is active low.</li>
<li><code>CLK</code> is active high.</li>
<li><code>CLK</code> speed is larger than 500 kHz.</li>
<li>Data is valid on leading edge of <code>CLK</code>.</li>
<li>Data is sent in multiples of 8-bits (octets).</li>
<li>Octets are sent most-significant bit first.</li>
</ul>
<p>This recommended configuration may be adjusted depending on the individual needs of the application or product.</p>
<h3>SPI Framing Protocol</h3>
<p>Each SPI frame starts with a 5-byte frame header:</p>
<table class="doxtable">
<tr>
<th>Octets: </th><th>1 </th><th>2 </th><th>2  </th></tr>
<tr>
<td>Fields: </td><td>HDR </td><td>RECV_LEN </td><td>DATA_LEN </td></tr>
</table>
<ul>
<li><code>HDR</code>: The first byte is the header byte (defined below)</li>
<li><code>RECV_LEN</code>: The second and third bytes indicate the largest frame size that that device is ready to receive. If zero, then the other device must not send any data. (Little endian)</li>
<li><code>DATA_LEN</code>: The fourth and fifth bytes indicate the size of the pending data frame to be sent to the other device. If this value is equal-to or less-than the number of bytes that the other device is willing to receive, then the data of the frame is immediately after the header. (Little Endian)</li>
</ul>
<p>The <code>HDR</code> byte is defined as: </p><pre class="fragment">  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
|RST|CRC|CCF|  RESERVED |PATTERN|
+---+---+---+---+---+---+---+---+
</pre><ul>
<li><code>RST</code>: This bit is set when that device has been reset since the last time <code>C̅S̅</code> was asserted.</li>
<li><code>CRC</code>: This bit is set when that device supports writing a 16-bit CRC at the end of the data. The CRC length is NOT included in DATA_LEN.</li>
<li><code>CCF</code>: "CRC Check Failure". Set if the CRC check on the last received frame failed, cleared to zero otherwise. This bit is only used if both sides support CRC.</li>
<li><code>RESERVED</code>: These bits are all reserved for future used. They MUST be cleared to zero and MUST be ignored if set.</li>
<li><code>PATTERN</code>: These bits are set to a fixed value to help distinguish valid SPI frames from garbage (by explicitly making <code>0xFF</code> and <code>0x00</code> invalid values). Bit 6 MUST be set to be one and bit 7 MUST be cleared (0). A frame received that has any other values for these bits MUST be dropped.</li>
</ul>
<p>Prior to a sending or receiving a frame, the master MAY send a 5-octet frame with zeros for both the max receive frame size and the the contained frame length. This will induce the slave device to indicate the length of the frame it wants to send (if any) and indicate the largest frame it is capable of receiving at the moment. This allows the master to calculate the size of the next transaction. Alternatively, if the master has a frame to send it can just go ahead and send a frame of that length and determine if the frame was accepted by checking that the <code>RECV_LEN</code> from the slave frame is larger than the frame the master just tried to send. If the <code>RECV_LEN</code> is smaller then the frame wasn't accepted and will need to be transmitted again.</p>
<p>This protocol can be used either unidirectionally or bidirectionally, determined by the behavior of the master and the slave.</p>
<p>If the the master notices <code>PATTERN</code> is not set correctly, the master should consider the transaction to have failed and try again after 10 milliseconds, retrying up to 200 times. After unsuccessfully trying 200 times in a row, the master MAY take appropriate remedial action (like a NCP hardware reset, or indicating a communication failure to a user interface).</p>
<p>At the end of the data of a frame is an optional 16-bit CRC, support for which is indicated by the <code>CRC</code> bit of the <code>HDR</code> byte being set. If these bits are set for both the master and slave frames, then CRC checking is enabled on both sides, effectively requiring that frame sizes be two bytes longer than would be otherwise required. The CRC is calculated using the same mechanism used for the CRC calculation in HDLC-Lite (See (#hdlc-lite)). When both of the <code>CRC</code> bits are set, both sides must verify that the <code>CRC</code> is valid before accepting the frame. If not enough bytes were clocked out for the CRC to be read, then the frame must be ignored. If enough bytes were clocked out to perform a CRC check, but the CRC check fails, then the frame must be rejected and the <code>CRC_FAIL</code> bit on the next frame (and ONLY the next frame) MUST be set.</p>
<p>TBD</p>
<h2>Native USB Recommendations</h2>
<p>TBD </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Jun 21 2017 18:58:05 for OT-DW1000 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
